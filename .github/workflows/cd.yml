name: CD

on:
  push:
    branches: [main]

jobs:
  deploy-to-pages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Build web
        run: npx expo export

      - name: Corrige tous les chemins d'assets pour le sous-dossier
        run: |
          find dist -type f \( -name "*.js" -o -name "*.html" \) -exec sed -i 's|/assets/|/cesizen.github.io/assets/|g' {} +

      - name: Corrige les chemins des scripts dans index.html
        run: |
          sed -i 's|src="/_expo/|src="/cesizen.github.io/_expo/|g' dist/index.html

      - name: Corrige le chemin du favicon dans index.html
        run: |
          sed -i 's|href="/favicon.ico"|href="/cesizen.github.io/favicon.ico"|g' dist/index.html

      - name: Add .nojekyll
        run: touch dist/.nojekyll

      - name: Deploy to cesizen.github.io
        env:
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          cd dist
          git init
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git remote add origin https://x-access-token:${GH_TOKEN}@github.com/ttmartinks/cesizen.github.io.git
          git checkout -b main
          git add .
          git commit -m "Deploy from bloc4_frontend: $GITHUB_SHA" || echo "Nothing to commit"
          git push --force origin main

  simulate-android-deploy:
    runs-on: ubuntu-latest
    needs: deploy-to-pages
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Java (simulation)
        run: |
          echo "ğŸ”§ Setting up Java 11 for Android build..."
          echo "âœ… Java configured successfully"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies for Android build..."
          npm ci
          echo "âœ… Dependencies installed"

      - name: Setup EAS CLI (simulation)
        run: |
          echo "ğŸ› ï¸ Installing EAS CLI..."
          echo "âœ… EAS CLI installed and configured"

      - name: Configure Android build (simulation)
        run: |
          echo "ğŸ” Configuring Android certificates and signing..."
          echo "ğŸ“± Setting up Google Play Store credentials..."
          echo "âœ… Android build configuration completed"

      - name: Build Android AAB (simulation)
        run: |
          echo "ğŸ—ï¸ Building Android App Bundle (.aab)..."
          echo "ğŸ“± Platform: Android"
          echo "ğŸ¯ Target: Google Play Store"
          echo "â³ Estimated build time: 10-15 minutes"
          echo "âœ… Android AAB build completed successfully"

      - name: Upload to Google Play Console (simulation)
        run: |
          echo "ğŸš€ Uploading to Google Play Console..."
          echo "ğŸ“‹ Track: Internal Testing"
          echo "ğŸ” Running pre-launch report..."
          echo "âœ… Successfully uploaded to Google Play Store"
          echo "ğŸ“§ Notification sent to testers"

  simulate-ios-deploy:
    runs-on: ubuntu-latest  # En rÃ©alitÃ©, il faudrait macos-latest
    needs: deploy-to-pages
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Xcode (simulation)
        run: |
          echo "ğŸ Setting up Xcode for iOS build..."
          echo "ğŸ“± Note: In real scenario, this would run on macos-latest"
          echo "âœ… Xcode configured successfully"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies for iOS build..."
          npm ci
          echo "âœ… Dependencies installed"

      - name: Setup EAS CLI (simulation)
        run: |
          echo "ğŸ› ï¸ Installing EAS CLI for iOS..."
          echo "âœ… EAS CLI installed and configured"

      - name: Configure iOS build (simulation)
        run: |
          echo "ğŸ” Configuring iOS certificates and provisioning profiles..."
          echo "ğŸ Setting up Apple Developer credentials..."
          echo "ğŸ“± Bundle ID: com.cesi.cesizen"
          echo "âœ… iOS build configuration completed"

      - name: Build iOS IPA (simulation)
        run: |
          echo "ğŸ—ï¸ Building iOS App Archive (.ipa)..."
          echo "ğŸ“± Platform: iOS"
          echo "ğŸ¯ Target: App Store Connect"
          echo "â³ Estimated build time: 15-20 minutes"
          echo "âœ… iOS IPA build completed successfully"

      - name: Upload to App Store Connect (simulation)
        run: |
          echo "ğŸš€ Uploading to App Store Connect..."
          echo "ğŸ“‹ Track: TestFlight Internal Testing"
          echo "ğŸ” Running App Store review guidelines check..."
          echo "âœ… Successfully uploaded to App Store Connect"
          echo "ğŸ“§ TestFlight invitation sent to internal testers"

  deployment-summary:
    runs-on: ubuntu-latest
    needs: [deploy-to-pages, simulate-android-deploy, simulate-ios-deploy]
    steps:
      - name: Deployment Summary
        run: |
          echo "ğŸ‰ ===== DEPLOYMENT SUMMARY ====="
          echo ""
          echo "âœ… Web App: Successfully deployed to GitHub Pages"
          echo "   ğŸ“ URL: https://ttmartinks.github.io/cesizen.github.io/"
          echo ""
          echo "âœ… Android: Build and upload simulation completed"
          echo "   ğŸ“± Platform: Google Play Store (Internal Testing)"
          echo "   ğŸ—ï¸ Build type: AAB (Android App Bundle)"
          echo ""
          echo "âœ… iOS: Build and upload simulation completed"  
          echo "   ğŸ“± Platform: App Store Connect (TestFlight)"
          echo "   ğŸ—ï¸ Build type: IPA (iOS App Archive)"
          echo ""
          echo "ğŸš€ All platforms ready for distribution!"
          echo "ğŸ“Š Total deployment time: ~$(date -d@$SECONDS -u +%M:%S)"
